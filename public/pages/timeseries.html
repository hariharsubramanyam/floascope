<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <link type="text/css" rel="stylesheet" href="">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.runtime.min.js"></script>
  <script src="/js/templates.js"></script>

	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script src="../js/websocket_helper.js"></script>
  <script src="../js/flattener.js"></script>

  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.0/rickshaw.min.css">
  <script src="/js/prefix_filter.js"></script>
  <script src="/js/ui/prefix_ui.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
  <script src="http://fenixrepo.fao.org/cdn/faostat3/js/d3/d3.layout/1.0/d3.layout.js"></script> <!--sketchy cdn?-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.0/rickshaw.min.js"></script>
  <!--<script src="../js/timeseries.js"></script>-->

<style>

body {
padding: 30px;
font-family: Arial, Helvetica, sans-serif;
}

#chart_container {
position: relative;
width:1200px;
height:400px;
width: 90%;
}

#chart {
position: relative;
left: 40px;
}

#y_axis {
position: absolute;
top: 0;
bottom: 0;
width: 40px;
}

#legend_container {
  font-size: 1.5em;
}

#xlegend {
text-align: left;
}

#legend {
text-align: left;
}

.swatch {
display: inline-block;
width: 10px;
height: 10px;
margin: 0 8px 0 0;
}

.label {
display: inline-block;
}

.line {
display: inline-block;
margin-top: 8px;
}

#header {
height: 100px;
margin-top: 20px;
margin-bottom: 20px;
width: 1200px;
}

#prefix_ui {
width: 90%;
float: left;
}

#controls_container {
float: right;
}

#graph_options {
  margin-top: 20px;
  margin-bottom: 20px;
}

#graph_option_y_axis {
  width: 30%;
  float: left;
}

#graph_option_filter {
  width: 30%;
  float: left;
}

#graph_option_view {
  width: 30%;
  float: left;
}

#content {
  width: 75%;
  height: 100%;
  float: left;
}

#legend_container {
  width: 25%;
  height: 400px;
  float: left;
}

</style>


</head>
<body>

  <div id="header">
    <div id="prefix_ui"></div>
    <div id="controls_container">
        <button type="button"  id="play_toggle"> Pause </button>
    </div>

  </div>

  <div id="content">
    <div id="chart_container">

      <!-- graph html -->
      <div>
        <div id="y_axis"></div>
        <div id="chart" style="height:400px; width:1200px"></div>
      </div>

      <div id="graph_options">

        <form id="graph_option_y_axis" class="toggler">
                <div><b>y axis</b></div>
                <input checked type="radio" name="y-axis" id="throughput" value="throughput">
                  <label class="throughput" for="throughput">bytes/second</label><br>
                <input type="radio" name="y-axis" id="retransmits" value="retransmits">
                  <label class="retransmits" for="retransmits">percent retransmits/second</label>
        </form>

        <form id="graph_option_filter" class="toggler">
                <div><b>graph filter</b></div>
                <input checked type="radio" name="filter" id="all" value="all">
                  <label class="all" for="all">all pairs</label><br>
                <input type="radio" name="filter" id="to" value="to">
                  <label class="to" for="to">traffic to [prefix]</label><br>
                <input type="radio" name="filter" id="from" value="from">
                  <label class="from" for="from">traffic from [prefix]</label><br>
        </form>

        <form id="graph_option_view" class="toggler">
                <div><b>graph style</b></div>
                <input checked type="radio" name="offset" id="lines" value="lines">
                  <label class="lines" for="lines">lines</label><br>
                <input type="radio" name="offset" id="stack" value="zero">
                  <label class="stack" for="stack">stack</label>
        </form>
      </div> <!-- graph_options -->
    </div> <!-- chart_container -->


  </div> <!-- content -->

  <div id="legend_container">
    <div id="x-legend"></div>
    <div id="legend"></div>
  </div> <!-- legend_container -->


  <script>

    const TOTAL_THROUGPUT = "total_throughput";
    const SEND_THROUGHPUT = "send_throughput";
    const RECV_THROUGPUT = "recv_throughput";
    const TOTAL_RETRANS_PERCENTAGE = "total_retransmit_perc";
    const SEND_RETRANS_PERCENTAGE = "send_retransmit_perc";
    const RECV_RETRANS_PERCENTAGE = "recv_retransmit_perc";

    var prefixUI = PrefixUI("prefix_ui");
    var paused = false;
    var graph_data_accumulator = {};
    var tv = 250; // ms
    // instantiate
    var graph = new Rickshaw.Graph( {
      element: document.getElementById("chart"),
      renderer: 'line',
      series: new Rickshaw.Series.FixedDuration([{ name: 'zero' }], undefined, {
        timeInterval: tv,
        maxDataPoints: 60*1000/tv, // show a minute of data
        timeBase: new Date().getTime()/1000 // s
      })
    } );

    // axes
    var axes = new Rickshaw.Graph.Axis.Time( { graph: graph } );
    var y_axis = new Rickshaw.Graph.Axis.Y( {
            graph: graph,
            orientation: 'left',
            tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
            element: document.getElementById('y_axis'),
    } );

    // line/stack graph type toggle
    var offsetForm = document.getElementById('graph_option_view');
    offsetForm.addEventListener('change', function(e) {
            var offsetMode = e.target.value;

            if (offsetMode == 'lines') {
                    graph.setRenderer('line');
                    graph.offset = 'zero';
            } else {
                    graph.setRenderer('stack');
                    graph.offset = offsetMode;
            }
            graph.render();

    }, false);

    // Pause/Play toggle

    var playToggle = document.getElementById('play_toggle');
    playToggle.addEventListener('click', function(e){
      console.log(paused);
      if(paused){
        paused = false;
        playToggle.innerHTML = 'Pause';
      }
      else{
        paused = true;
        playToggle.innerHTML = 'Play'
      }

    }, false);
    // render for first time
    graph.render();

    // hovering legend
    var xlegend = document.querySelector('#x-legend');
    var legend = document.querySelector('#legend');
    var Hover = Rickshaw.Class.create(Rickshaw.Graph.HoverDetail, {
      render: function(args) {
        legend.innerHTML = "";
        xlegend.innerHTML = args.formattedXValue;
        args.detail.sort(function(a, b) {
          return a.order - b.order }
          ).forEach( function(d) {
            if (d.series.name != 'zero' && d.formattedYValue > 0) {
              var line = document.createElement('div');
              line.className = 'line';

              var swatch = document.createElement('div');
              swatch.className = 'swatch';
              swatch.style.backgroundColor = d.series.color;

              var label = document.createElement('div');
              label.className = 'label';
              label.innerHTML = d.name + ": " + d.formattedYValue + " bytes/s";
              line.appendChild(swatch);
              line.appendChild(label);
              legend.appendChild(line);

              var dot = document.createElement('div');
              dot.className = 'dot';
              dot.style.top = graph.y(d.value.y0 + d.value.y) + 'px';
              dot.style.borderColor = d.series.color;
              this.element.appendChild(dot);
              dot.className = 'dot active';

              this.show();

            }

        }, this );
            }
    });

    var hover = new Hover( { graph: graph } );

    var calculateThroughput = function(bytes, interval) {
      return bytes/interval * 1000; //Throughput in #bytes/ms
    };

    // update graph
    var graph_data = {};
    var iv = setInterval( function() {
      for (i in Object.keys(graph_data)) {
        var timestamp_s = Object.keys(graph_data)[i];

        for (j in Object.keys(graph_data[timestamp_s])) {
          graph_data_accumulator[j].push([graph_data[timestamp_s][j], timestamp_s]);
        }
        //TODO: Merry, please hook up the toggle of views so that way each key can be properly used
        //Keys are defined as constants at the top, and this (graph.series) should be repopulated whenever the toggle occurs.
        //When it does, find the appropriate accumulator, and cycle through it's list pairs so you have the inputs to the addData function, index 0 for data, 1 for ts

        graph.series.addData(graph_data[timestamp_s][TOTAL_THROUGHPUT], timestamp_s); // second granularity, for smoothness
      }
      if (!paused) graph.render();
      graph_data = {};
    }, tv );



    var ws = WebsocketHelper([function(data) {
      data = Flatten(data);
      data.filter(function(obj) {
        return prefixUI.filter().matchesFilter(obj.src)
          || prefixUI.filter().matchesFilter(obj.dst);
      }).forEach(function(obj) {
        var source_ip = obj.src_host || obj.src;
        var dest_ip = obj.dst_host || obj.dst;

        var timestamp_s = obj.time_stamp / 1000;
        var total_throughput = calculateThroughput(obj["num_bytes_inst"],obj["interval"]);
        var send_throughput = calculateThroughput(obj["num_send_bytes_inst"], obj["interval"]);
        var recv_throughput = calculateThroughput(obj["num_recv_bytes_inst"], obj["interval"]);

        var total_retrans_percentage = obj["num_retrans_bytes_inst"]/obj["num_bytes_inst"] * 100;
        var send_retrans_percentage = obj["send_retrans_bytes_inst"]/obj["num_send_bytes_inst"] * 100;
        var recv_retrans_percentage = obj["recv_retrans_bytes_inst"]/obj["num_recv_bytes_inst"] * 100;

        if (!(timestamp_s in graph_data)) graph_data[timestamp_s] = {};
        if (!(source_ip in graph_data[timestamp_s])) graph_data[timestamp_s][source_ip] = 0;

        graph_data[timestamp_s][TOTAL_THROUGHPUT][key] = graph_data[timestamp_s][TOTAL_THROUGHPUT][key] + total_throughput;
        graph_data[timestamp_s][SEND_THROUGHPUT][source_ip] = graph_data[timestamp_s][SEND_THROUGHPUT][source_ip] + send_throughput;
        graph_data[timestamp_s][RECV_THROUGHPUT][dest_ip] = graph_data[timestamp_s][RECV_THROUGHPUT][dest_ip] + recv_throughput;
        graph_data[timestamp_s][TOTAL_RETRANS_PERCENTAGE][key] = graph_data[timestamp_s][TOTAL_RETRANS_PERCENTAGE][source_ip] + total_retrans_percentage;
        graph_data[timestamp_s][SEND_RETRANS_PERCENTAGE][source_ip] = graph_data[timestamp_s][SEND_RETRANS_PERCENTAGE][source_ip] + send_retrans_percentage;
        graph_data[timestamp_s][RECV_RETRANS_PERCENTAGE][dest_ip] = graph_data[timestamp_s][RECV_RETRANS_PERCENTAGE][dest_ip] + recv_retrans_percentage;



      });
    }], [function() {
      console.log('Client has connected to the server!');
      ws.sendMessage({"message": "Hi there"});
    }], [function() {
      console.log('The client has disconnected!');
    }]);

  </script>
</body>
</html>
