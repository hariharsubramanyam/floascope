<!doctype html>
<head>
	<link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">
	<link type="text/css" rel="stylesheet" href="../css/vendor/rickshaw/graph.css">
	<link type="text/css" rel="stylesheet" href="../css/vendor/rickshaw/detail.css">
	<link type="text/css" rel="stylesheet" href="../css/vendor/rickshaw/legend.css">
	<link type="text/css" rel="stylesheet" href="../css/vendor/extensions.css?v=2">
  <link type="text/css" rel="stylesheet" href="../css/timeseries_style.css">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script>
		jQuery.noConflict();
	</script>

	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>

	<script src="../js/vendor/rickshaw/Rickshaw.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Class.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Compat.ClassList.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Area.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Line.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Bar.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.ScatterPlot.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Stack.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.RangeSlider.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.RangeSlider.Preview.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.HoverDetail.js"></script>
	<!-- <script src="../js/vendor/rickshaw/Rickshaw.Graph.Annotate.js"></script> -->
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Legend.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Axis.Time.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Behavior.Series.Toggle.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Behavior.Series.Order.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Behavior.Series.Highlight.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Smoother.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Time.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Time.Local.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Number.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Fixtures.RandomData.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Color.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Color.Palette.js"></script>
	<script src="../js/vendor/rickshaw/Rickshaw.Graph.Axis.Y.js"></script>

	<script src="../js/vendor/extensions.js"></script>

	<!-- from original timeseries.html -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.runtime.min.js"></script>
  <script src="   /js/templates.js"></script>

	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script src="../js/websocket_helper.js"></script>
	<script src="../js/flattener.js"></script>

	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.0/rickshaw.min.css">
	<script src="/js/prefix_filter.js"></script>
	<script src="/js/buffer.js"></script>
  <script src="/js/ui/interval_ui.js"></script>
	<script src="/js/ui/prefix_ui.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
	<script src="/js/vendor/d3.layout.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.0/rickshaw.min.js"></script>
	<!--<script src="../js/timeseries.js"></script>-->


</head>
<body>

<div id="content">

	<form id="side_panel">
		<h1>Floascope</h1>
		<h2 id="yAxisLabel">Throughput (bytes/s) </h2>
		<h2>vs.</h2>
		<h2 id="xAxisLabel">Time (s)</h2>
		<section><div id="legend"></div></section>
		<section>
			<div id="renderer_form" class="toggler">
				<input type="radio" name="renderer" id="area" value="area" checked>
				<label for="area">area</label>
				<input type="radio" name="renderer" id="bar" value="bar">
				<label for="bar">bar</label>
				<input type="radio" name="renderer" id="line" value="line">
				<label for="line">line</label>
			</div>
		</section>
		<section>
			<div id="offset_form">
				<label for="stack">
					<input type="radio" name="offset" id="stack" value="zero" checked>
					<span>stack</span>
				</label>
				<label for="stream" style="display:none">
					<input type="radio" name="offset" id="stream" value="wiggle">
					<span>stream</span>
				</label>
				<label for="pct">
					<input type="radio" name="offset" id="pct" value="expand">
					<span>pct</span>
				</label>
				<label for="value">
					<input type="radio" name="offset" id="value" value="value">
					<span>value</span>
				</label>
			</div>
			<div id="interpolation_form">
				<label for="cardinal">
					<input type="radio" name="interpolation" id="cardinal" value="cardinal" checked>
					<span>cardinal</span>
				</label>
				<label for="linear">
					<input type="radio" name="interpolation" id="linear" value="linear">
					<span>linear</span>
				</label>
			</div>
		</section>
		<section></section>
	</form>

	<div id="chart_container">
		<div id="chart"></div>
		<div id="timeline"></div>
		<div id="preview"></div>
	</div>

</div>
<div id="interval_ui"></div>

<script>


// START OUR CODE

var setAxesLabels = function(yLabel, xLabel) {
  xLabel = xLabel || "Time (s)";
  yLabel = yLabel || "Throughput (bytes/s)";
  document.getElementById("yAxisLabel").innerHTML = yLabel;
  document.getElementById("xAxisLabel").innerHTML = xLabel;
};

// Create a drop-oldest buffer with a 10,000 element capacity. We'll
// put the server data in this buffer and use buffer.replay(fn) to play back
// the server data when switching series.
var buffer = ItemBuffer(10000);

const NUM_BYTES_INST = "num_bytes_inst";
const SEND_THROUGHPUT = "send_throughput";
const RECV_THROUGHPUT = "recv_throughput";
const TOTAL_RETRANS_PERCENTAGE = "total_retransmit_perc";
const SEND_RETRANS_PERCENTAGE = "send_retransmit_perc";
const RECV_RETRANS_PERCENTAGE = "recv_retransmit_perc";
var current_field = NUM_BYTES_INST;

// instantiate our graph!
var tv = 1000; // ms
// instantiate
var graph = new Rickshaw.Graph( {
	element: document.getElementById("chart"),
	width: 900,
	height: 500,
	renderer: 'line',
	interpolation: 'linear',
	stroke: true,
	preserve: true,
	series: new Rickshaw.Series.FixedDuration([{ name: 'zero' }], undefined, {
		disabled: true,
		timeInterval: tv,
		maxDataPoints: 60*1000/tv, // show a minute of data
		timeBase: new Date().getTime()/1000 // s
	})
} );

graph.render();
// END OUR CODE


var preview = new Rickshaw.Graph.RangeSlider( {
	graph: graph,
	element: document.getElementById('preview'),
} );

var hoverDetail = new Rickshaw.Graph.HoverDetail( {
	graph: graph,
	xFormatter: function(x) {
		return new Date(x * 1000).toString();
	}
} );

var legend = new Rickshaw.Graph.Legend( {
	graph: graph,
	element: document.getElementById('legend')

} );

var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
	graph: graph,
	legend: legend
} );

legend.shelving = shelving;
graph.series.legend = legend;

var order = new Rickshaw.Graph.Behavior.Series.Order( {
	graph: graph,
	legend: legend
} );

var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight( {
	graph: graph,
	legend: legend
} );

var ticksTreatment = 'glow';

var xAxis = new Rickshaw.Graph.Axis.Time( {
	graph: preview.graph,
	ticksTreatment: ticksTreatment,
	timeFixture: new Rickshaw.Fixtures.Time.Local()
} );

xAxis.render();
var logScale = d3.scale.log();
var linearScale = d3.scale.linear();
var yAxis = new Rickshaw.Graph.Axis.Y.Scaled( {
	graph: graph,
	orientation: 'right',
	tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
	ticksTreatment: ticksTreatment,
	scale: linearScale
} );

yAxis.render();

var controls = new RenderControls( {
	element: document.querySelector('form'),
	graph: graph
} );

//////////////////// START OUR CODE


// update graph
var max_ts = 0;

var ws = WebsocketHelper([function(data) {
  buffer.buffer(data);
  data = Flatten(data);

  var dataForThisTick = {};
  var timestamp = (new Date()).getTime() / 1000.0;
	data.forEach(function(obj) {
		var source_ip = obj.src_host || obj.src;
		var dest_ip = obj.dst_host || obj.dst;
    var key = source_ip + "<br>" + dest_ip; 

		var value = obj[current_field];

    dataForThisTick[key] = value;
	});

  graph.series.addData(dataForThisTick, timestamp);
  graph.render();
  legend.render();
  shelving.updateBehaviour();
}], [function() {
  console.log('Client has connected to the server!');
  ws.sendMessage({"message": "We're in the connect handler"});
}], [function() {
  console.log('The client has disconnected!');
}]);
var intervalUI = IntervalUI("interval_ui", ws);
ws.sendMessage({"message" : "Yes we get this far"});
</script>

</body>
