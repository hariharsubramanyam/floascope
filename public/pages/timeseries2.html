<!doctype html>
<head>
    <link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">
    <link type="text/css" rel="stylesheet" href="../css/vendor/rickshaw/graph.css">
    <link type="text/css" rel="stylesheet" href="../css/vendor/rickshaw/detail.css">
    <link type="text/css" rel="stylesheet" href="../css/vendor/rickshaw/legend.css">
    <link type="text/css" rel="stylesheet" href="../css/vendor/extensions.css?v=2">
    <link type="text/css" rel="stylesheet" href="../css/timeseries_style.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script>
        jQuery.noConflict();
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>

    <script src="../js/vendor/rickshaw/Rickshaw.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Class.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Compat.ClassList.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Area.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Line.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Bar.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.ScatterPlot.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Renderer.Stack.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.RangeSlider.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.RangeSlider.Preview.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.HoverDetail.js"></script>
    <!-- <script src="../js/vendor/rickshaw/Rickshaw.Graph.Annotate.js"></script> -->
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Legend.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Axis.Time.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Behavior.Series.Toggle.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Behavior.Series.Order.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Behavior.Series.Highlight.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Smoother.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Time.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Time.Local.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Number.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Fixtures.RandomData.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Fixtures.Color.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Color.Palette.js"></script>
    <script src="../js/vendor/rickshaw/Rickshaw.Graph.Axis.Y.js"></script>

    <script src="../js/vendor/extensions.js"></script>

    <!-- from original timeseries.html -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.runtime.min.js"></script>
  <script src="   /js/templates.js"></script>

    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="../js/websocket_helper.js"></script>
    <script src="../js/flattener.js"></script>

    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.0/rickshaw.min.css">
    <script src="/js/prefix_filter.js"></script>
  <script src="/js/ui/interval_ui.js"></script>
  <script src="/js/ui/pause_play_ui.js"></script>
    <script src="/js/ui/prefix_ui.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="/js/vendor/d3.layout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.6.0/rickshaw.min.js"></script>
    <!--<script src="../js/timeseries.js"></script>-->


</head>
<body>

<div id="content">
    <form id="side_panel">
        <h1>Floascope</h1>
        <h2>
            <span id="yAxisLabel">Throughput (bytes/s)</span> vs.
            <br>
            <span id="xAxisLabel">Time (s)</span>
        </h2>
        <section>
            <div id="dataset_form">
                <label for="total_throughput">
                    <input type="radio" name="dataset" id="total_throughput" value="Total Throughput (bytes/s)" checked>
                    <span>Total Throughput (bytes/s)</span>
                </label><br>
                <label for="send_throughput">
                    <input type="radio" name="dataset" id="send_throughput" value="Sent Throughput (bytes/s)">
                    <span>Sent Throughput (bytes/s)</span>
                </label><br>
                <label for="recv_throughput">
                    <input type="radio" name="dataset" id="recv_throughput" value="Receive Throughput (bytes/s)">
                    <span>Receive Throughput (bytes/s)</span>
                </label><br>
                <label for="total_retrans_perc">
                    <input type="radio" name="dataset" id="total_retransmit_perc" value="% Total Retransmission" >
                    <span>% Total Retransmission</span>
                </label><br>
                <label for="send_retransmit_perc">
                    <input type="radio" name="dataset" id="send_retransmit_perc" value="% Send Retransmission">
                    <span>% Send Retransmission</span>
                </label><br>
                <label for="recv_retransmit_perc">
                    <input type="radio" name="dataset" id="recv_retransmit_perc" value="% Received Retrasnmission">
                    <span>% Received Retrasnmission</span>
                </label>
            </div>
        </section>

        <section>
            <div id="renderer_form" class="toggler">
                <input type="radio" name="renderer" id="line" value="line" checked>
                <label for="line">line</label>
            </div>
        </section>


        <section>
            <div id="offset_form">
                <label for="value">
                    <input type="radio" name="offset" id="value" value="value" checked>
                    <span>value</span>
                </label>
            </div>
            <div id="interpolation_form">
                <label for="cardinal">
                    <input type="radio" name="interpolation" id="cardinal" value="cardinal">
                    <span>cardinal</span>
                </label>
                <label for="linear">
                    <input type="radio" name="interpolation" id="linear" value="linear" checked>
                    <span>linear</span>
                </label>
            </div>
        </section>
        <section><div id="legend"></div></section>
        <section></section>
    </form>

    <div id="chart_container">
        <div id="header">
            <div id="interval_ui"></div>
            <div id="pause_play_ui"></div>
        </div>

        <div id="chart"></div>
        <div id="timeline"></div>
        <!-- <div id="preview"></div> -->
        </div>
    </div>

</div>

<script>


// START OUR CODE

var setAxesLabels = function(yLabel, xLabel) {
  xLabel = xLabel || "Time (s)";
  yLabel = yLabel || "Throughput (bytes/s)";
  document.getElementById("yAxisLabel").innerHTML = yLabel;
  document.getElementById("xAxisLabel").innerHTML = xLabel;
};

const TOTAL_THROUGHPUT = "total_throughput";
const SEND_THROUGHPUT = "send_throughput";
const RECV_THROUGHPUT = "recv_throughput";
const TOTAL_RETRANS_PERCENTAGE = "total_retransmit_perc";
const SEND_RETRANS_PERCENTAGE = "send_retransmit_perc";
const RECV_RETRANS_PERCENTAGE = "recv_retransmit_perc";
var current_graph = TOTAL_THROUGHPUT;

// instantiate our graph!
var tv = 1000; // ms
// instantiate


var calculateRetransPercentage = function(retransmit_bytes, total_bytes){
    if (retransmit_bytes > total_bytes) {
      console.log('failure');

    }
    else{
      console.log(retransmit_bytes, total_bytes, retransmit_bytes/total_bytes);

      console.log('success');
    }
    return retransmit_bytes/total_bytes * 100 || 0;
};

var calculateThroughput = function(bytes, interval) {
    return bytes/interval * 1000 || 0; //Throughput in #bytes/ms; return 0 if anything is null
};

var makeSeries = function() {
  return new Rickshaw.Series.FixedDuration([{ name: 'base' }], undefined, {
    disabled: true,
    timeInterval: tv,
    maxDataPoints: 60*1000/tv, // show a minute of data
    timeBase: new Date().getTime()/1000 // s
  })
};


const computerForField = {};
const makeEntry = function(fn) {
  return {
    "series": makeSeries(),
    "getValue": fn,
    "tmpMap": {}
  };
};
computerForField[TOTAL_THROUGHPUT] = makeEntry(function(obj) {
  return calculateThroughput(obj["num_bytes_inst"],obj["interval"]);
});
computerForField[SEND_THROUGHPUT] = makeEntry(function(obj) {
  return calculateThroughput(obj["num_send_bytes_inst"], obj["interval"]);
});
computerForField[RECV_THROUGHPUT] = makeEntry(function(obj) {
  return calculateThroughput(obj["num_recv_bytes_inst"], obj["interval"]);
});
computerForField[TOTAL_RETRANS_PERCENTAGE] = makeEntry(function(obj) {
  return calculateRetransPercentage(obj["num_retrans_bytes_inst"],obj["num_bytes_inst"]);
});
computerForField[SEND_RETRANS_PERCENTAGE] = makeEntry(function(obj) {
  return calculateRetransPercentage(obj["send_retrans_bytes_inst"],obj["num_send_bytes_inst"]);
});
computerForField[RECV_RETRANS_PERCENTAGE] = makeEntry(function(obj) {
  return calculateRetransPercentage(obj["recv_retrans_bytes_inst"],obj["num_recv_bytes_inst"]);
});

var graph = new Rickshaw.Graph( {
    element: document.getElementById("chart"),
    width: document.getElementById("content").offsetWidth*.9 - 270,
    height: 500,
    renderer: 'line',
    interpolation: 'linear',
    stroke: true,
    preserve: true,
    series: makeSeries()
} );

graph.render();
// END OUR CODE

jQuery(function($){
    $("input[name=dataset]").change(function (e) {
    current_graph = e.target.id;
    for(var i = 0; i < computerForField[current_graph].series.length; i++) {
      graph.series[i] = computerForField[current_graph].series[i];
    }
    setAxesLabels(yLabel=e.target.value);
    console.log()
    graph.render();
    legend.render();
    shelving.updateBehaviour();
    })
});


// var preview = new Rickshaw.Graph.RangeSlider( {
//     graph: graph,
//     element: document.getElementById('preview'),
// } );

var hoverDetail = new Rickshaw.Graph.HoverDetail( {
    graph: graph,
    xFormatter: function(x) {
        return new Date(x * 1000).toString();
    }
} );

var legend = new Rickshaw.Graph.Legend( {
    graph: graph,
    element: document.getElementById('legend')

} );

var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
    graph: graph,
    legend: legend
} );

legend.shelving = shelving;
graph.series.legend = legend;

var order = new Rickshaw.Graph.Behavior.Series.Order( {
    graph: graph,
    legend: legend
} );

var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight( {
    graph: graph,
    legend: legend
} );

var ticksTreatment = 'glow';

var xAxis = new Rickshaw.Graph.Axis.Time( {
    graph: graph,
    ticksTreatment: ticksTreatment,
    timeFixture: new Rickshaw.Fixtures.Time.Local()
} );

xAxis.render();
var logScale = d3.scale.log();
var linearScale = d3.scale.linear();
var yAxis = new Rickshaw.Graph.Axis.Y.Scaled( {
    graph: graph,
    orientation: 'right',
    tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
    ticksTreatment: ticksTreatment,
    scale: linearScale
} );

yAxis.render();

var controls = new RenderControls( {
    element: document.querySelector('form'),
    graph: graph
} );

//////////////////// START OUR CODE

var handleNewData = function(fullData) {
  var data = fullData.connections;
  var timestamp = fullData.timestamp;
  data = Flatten(data);
  graph.series.addData({"base" : 0}, timestamp);

  Object.keys(computerForField).forEach(function(key) {
    computerForField[key].tmpMap = {};
  });

  data.forEach(function(obj) {
    var source_ip = obj.src_host || obj.src;
    var dest_ip = obj.dst_host || obj.dst;
    var key = source_ip + "<br>" + dest_ip; // doing this since obj.key includes port numbers
    Object.keys(computerForField).forEach(function(k) {
        computerForField[k].tmpMap[key] = computerForField[k].getValue(obj);
    });
  });

  Object.keys(computerForField).forEach(function(k) {
    computerForField[k].series.addData(computerForField[k].tmpMap, timestamp);
  });
    graph.series.addData(computerForField[current_graph].tmpMap, timestamp);
}


var ws = WebsocketHelper(
[function(data) {
  if (pausePlayUI.isPaused()) {
        return;
      }
		handleNewData(data);
		graph.render();
		legend.render();
		shelving.updateBehaviour();
	}
], [function() {
  console.log('Client has connected to the server!');
  ws.sendMessage({"message": "We're in the connect handler"});
}], [function() {
  console.log('The client has disconnected!');
}]);
var intervalUI = IntervalUI("interval_ui", ws);
var pausePlayUI = PausePlayUI("pause_play_ui");
ws.sendMessage({"message" : "Yes we get this far"});
</script>

</body>
